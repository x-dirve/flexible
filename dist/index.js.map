{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["interface Flexible {\n    rem: number;\n    dpr: number;\n    refreshRem(): void;\n    rem2px(d: any): number | string;\n    px2rem(d: any): number | string;\n}\n\nconst doc = window.document;\nconst dEl = doc.documentElement;\n\n// 定义 viewport 的 meta\nvar mEl = doc.querySelector('meta[name=\"viewport\"]');\n// 指定 flexible 的 meta\nvar fEl = doc.querySelector('meta[name=\"flexible\"]');\n// 像素比 Device Pixel Ratio\nvar dpr = 0;\n// 缩放比例\nvar scale = 0;\n// 计时器\nvar tid;\n// 初始化状态\nvar inited = false;\n\n/**提供给外部的调用对象 */\nconst flexible: Partial<Flexible> = {};\n\nfunction log(msg) {\n    console.log(\"%c[Flexible]\", \"color: cyan;\", msg);\n}\n\n/**缓存宽度标记 */\nvar Stigma = \"\";\nconst WINDOW_WIDTH_KEY = \"WINDOW_WIDTH\";\n\n/**\n * 生成当前项目的特征 key\n * @param key 标识\n */\nfunction buildStigma(key:string, raw:boolean) {\n    Stigma = `FLEXIBLE_${ raw  ? key : typeof (window.btoa) === \"function\" ? btoa(key) : key}_${WINDOW_WIDTH_KEY}`;\n}\n\n/**设置 meta */\nfunction setMetaAttr() {\n    if (mEl) {\n        log(\"将根据设置了 viewport 的 meta 标签来设置缩放比例\");\n        var match = mEl.getAttribute(\"content\").match(/initial\\-scale=([\\d\\.]+)/);\n        if (match) {\n            scale = parseFloat(match[1]);\n            dpr = parseInt(String(1 / scale), 10);\n        }\n    } else if (fEl) {\n        log(\"将根据设置了 flexible 的 meta 标签来设置缩放比例\");\n        var content = fEl.getAttribute(\"content\");\n        if (content) {\n            var initialDpr = content.match(/initial\\-dpr=([\\d\\.]+)/);\n            var maximumDpr = content.match(/maximum\\-dpr=([\\d\\.]+)/);\n            if (initialDpr) {\n                dpr = parseFloat(initialDpr[1]);\n                scale = parseFloat((1 / dpr).toFixed(2));\n            }\n            if (maximumDpr) {\n                dpr = parseFloat(maximumDpr[1]);\n                scale = parseFloat((1 / dpr).toFixed(2));\n            }\n        }\n    }\n\n    if (!dpr && !scale) {\n        var isIPhone = window.navigator.appVersion.match(/iphone/gi);\n        var devicePixelRatio = window.devicePixelRatio;\n        if (isIPhone) {\n            // iOS下，对于2和3的屏，用2倍的方案，其余的用1倍方案\n            if (devicePixelRatio >= 3 && (!dpr || dpr >= 3)) {\n                dpr = 3;\n            } else if (devicePixelRatio >= 2 && (!dpr || dpr >= 2)) {\n                dpr = 2;\n            } else {\n                dpr = 1;\n            }\n        } else {\n            // 其他设备下，仍旧使用1倍的方案\n            dpr = 1;\n        }\n        scale = 1 / dpr;\n    }\n\n    dEl.setAttribute(\"data-dpr\", String(dpr));\n\n    if (!mEl) {\n        mEl = doc.createElement(\"meta\");\n        mEl.setAttribute(\"name\", \"viewport\");\n        mEl.setAttribute(\"content\", `initial-scale=${scale}, maximum-scale=${scale}, minimum-scale=${scale}, user-scalable=no`);\n        if (dEl.firstElementChild) {\n            dEl.firstElementChild.appendChild(mEl);\n        } else {\n            var wrap = doc.createElement(\"div\");\n            wrap.appendChild(mEl);\n            doc.write(wrap.innerHTML);\n        }\n    }\n}\n\n\n/**更新页面字体大小 */\nfunction refreshRem() {\n    var width = dEl.getBoundingClientRect().width;\n\n    if (localStorage) {\n        if (width) {\n            localStorage.setItem(Stigma, String(width))\n        } else {\n            width = Number(localStorage.getItem(Stigma))\n        }\n    }\n    if (width / dpr > 540) {\n        width = 540 * dpr;\n    }\n\n    var rem = width / 10;\n    dEl.style.fontSize = `${rem}px`;\n\n    //某些安卓机会对设置的 font-size 自动乘以一个系数导致页面偏大\n    var effectSize = parseFloat(getComputedStyle(dEl).fontSize);\n    if (effectSize != rem) {\n        dEl.style.fontSize = `${rem * rem / effectSize}px`;\n    }\n\n    flexible.rem = rem;\n}\n\n/**设置相关事件监听逻辑 */\nfunction setEventListener() {\n    window.addEventListener(\"resize\", function () {\n        clearTimeout(tid);\n        tid = setTimeout(refreshRem, 300);\n    }, false);\n    window.addEventListener(\"pageshow\", function (e) {\n        if (e.persisted) {\n            clearTimeout(tid);\n            tid = setTimeout(refreshRem, 300);\n        }\n    }, false);\n\n    if (doc.readyState === \"complete\") {\n        doc.body.style.fontSize = `${12 * dpr}px`;\n    } else {\n        doc.addEventListener(\"DOMContentLoaded\", function () {\n            doc.body.style.fontSize = `${12 * dpr}px`;\n        }, false);\n    }\n}\n\nexport { flexible }\n\n/**\n * 初始化\n * @param s 项目标识，用于防止同域下的项目互相覆盖\n * @param raw 是否将标识直接用于生成模块特征\n */\nexport default function init(s?:string, raw:boolean = false) {\n    if (inited) {\n        log(\"已初始化完成，相关操作请调用 flexible 对象完成\");\n        return;\n    }\n\n    buildStigma(\n        s || window.location.host\n        , raw\n    );\n\n    setMetaAttr();\n\n    setEventListener();\n\n    refreshRem();\n\n    /**更新对外调用对象 */\n    flexible.dpr = dpr;\n    flexible.refreshRem = refreshRem;\n    flexible.rem2px = function (d) {\n        var val: any = parseFloat(d) * this.rem;\n        if (typeof d === \"string\" && d.match(/rem$/)) {\n            val += \"px\";\n        }\n        return val;\n    }\n    flexible.px2rem = function (d) {\n        var val: any = parseFloat(d) / this.rem;\n        if (typeof d === \"string\" && d.match(/px$/)) {\n            val += \"rem\";\n        }\n        return val;\n    }\n};\n"],"names":["const"],"mappings":";;;;AAQAA,IAAM,GAAG,GAAG,MAAM,CAAC,QAAQ,CAAC;AAC5BA,IAAM,GAAG,GAAG,GAAG,CAAC,eAAe,CAAC;AAEhC;AACA,IAAI,GAAG,GAAG,GAAG,CAAC,aAAa,CAAC,uBAAuB,CAAC,CAAC;AACrD;AACA,IAAI,GAAG,GAAG,GAAG,CAAC,aAAa,CAAC,uBAAuB,CAAC,CAAC;AACrD;AACA,IAAI,GAAG,GAAG,CAAC,CAAC;AACZ;AACA,IAAI,KAAK,GAAG,CAAC,CAAC;AACd;AACA,IAAI,GAAG,CAAC;AAIR;IACM,QAAQ,GAAsB,GAAG;AAEvC,SAAS,GAAG,CAAC,GAAG;IACZ,OAAO,CAAC,GAAG,CAAC,cAAc,EAAE,cAAc,EAAE,GAAG,CAAC,CAAC;AACrD,CAAC;AAED;AACA,IAAI,MAAM,GAAG,EAAE,CAAC;AAChBA,IAAM,gBAAgB,GAAG,cAAc,CAAC;AAExC;;;;AAIA,SAAS,WAAW,CAAC,GAAU,EAAE,GAAW;IACxC,MAAM,GAAG,eAAa,GAAG,GAAI,GAAG,GAAG,QAAQ,MAAM,CAAC,IAAI,CAAC,KAAK,UAAU,GAAG,IAAI,CAAC,GAAG,CAAC,GAAG,IAAG,SAAI,gBAAkB,CAAC;AACnH,CAAC;AAED;AACA,SAAS,WAAW;IAChB,IAAI,GAAG,EAAE;QACL,GAAG,CAAC,kCAAkC,CAAC,CAAC;QACxC,IAAI,KAAK,GAAG,GAAG,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC,KAAK,CAAC,0BAA0B,CAAC,CAAC;QAC1E,IAAI,KAAK,EAAE;YACP,KAAK,GAAG,UAAU,CAAC,KAAK,CAAC,CAAC,CAAC,CAAC,CAAC;YAC7B,GAAG,GAAG,QAAQ,CAAC,MAAM,CAAC,CAAC,GAAG,KAAK,CAAC,EAAE,EAAE,CAAC,CAAC;SACzC;KACJ;SAAM,IAAI,GAAG,EAAE;QACZ,GAAG,CAAC,kCAAkC,CAAC,CAAC;QACxC,IAAI,OAAO,GAAG,GAAG,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC;QAC1C,IAAI,OAAO,EAAE;YACT,IAAI,UAAU,GAAG,OAAO,CAAC,KAAK,CAAC,wBAAwB,CAAC,CAAC;YACzD,IAAI,UAAU,GAAG,OAAO,CAAC,KAAK,CAAC,wBAAwB,CAAC,CAAC;YACzD,IAAI,UAAU,EAAE;gBACZ,GAAG,GAAG,UAAU,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC;gBAChC,KAAK,GAAG,UAAU,CAAC,CAAC,CAAC,GAAG,GAAG,EAAE,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC;aAC5C;YACD,IAAI,UAAU,EAAE;gBACZ,GAAG,GAAG,UAAU,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC;gBAChC,KAAK,GAAG,UAAU,CAAC,CAAC,CAAC,GAAG,GAAG,EAAE,OAAO,CAAC,CAAC,CAAC,CAAC,CAAC;aAC5C;SACJ;KACJ;IAED,IAAI,CAAC,GAAG,IAAI,CAAC,KAAK,EAAE;QAChB,IAAI,QAAQ,GAAG,MAAM,CAAC,SAAS,CAAC,UAAU,CAAC,KAAK,CAAC,UAAU,CAAC,CAAC;QAC7D,IAAI,gBAAgB,GAAG,MAAM,CAAC,gBAAgB,CAAC;QAC/C,IAAI,QAAQ,EAAE;;YAEV,IAAI,gBAAgB,IAAI,CAAC,KAAK,CAAC,GAAG,IAAI,GAAG,IAAI,CAAC,CAAC,EAAE;gBAC7C,GAAG,GAAG,CAAC,CAAC;aACX;iBAAM,IAAI,gBAAgB,IAAI,CAAC,KAAK,CAAC,GAAG,IAAI,GAAG,IAAI,CAAC,CAAC,EAAE;gBACpD,GAAG,GAAG,CAAC,CAAC;aACX;iBAAM;gBACH,GAAG,GAAG,CAAC,CAAC;aACX;SACJ;aAAM;;YAEH,GAAG,GAAG,CAAC,CAAC;SACX;QACD,KAAK,GAAG,CAAC,GAAG,GAAG,CAAC;KACnB;IAED,GAAG,CAAC,YAAY,CAAC,UAAU,EAAE,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC;IAE1C,IAAI,CAAC,GAAG,EAAE;QACN,GAAG,GAAG,GAAG,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC;QAChC,GAAG,CAAC,YAAY,CAAC,MAAM,EAAE,UAAU,CAAC,CAAC;QACrC,GAAG,CAAC,YAAY,CAAC,SAAS,sBAAmB,KAAK,wBAAmB,KAAK,wBAAmB,KAAK,yBAAqB,CAAC;QACxH,IAAI,GAAG,CAAC,iBAAiB,EAAE;YACvB,GAAG,CAAC,iBAAiB,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC;SAC1C;aAAM;YACH,IAAI,IAAI,GAAG,GAAG,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;YACpC,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC;YACtB,GAAG,CAAC,KAAK,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;SAC7B;KACJ;AACL,CAAC;AAGD;AACA,SAAS,UAAU;IACf,IAAI,KAAK,GAAG,GAAG,CAAC,qBAAqB,EAAE,CAAC,KAAK,CAAC;IAE9C,IAAI,YAAY,EAAE;QACd,IAAI,KAAK,EAAE;YACP,YAAY,CAAC,OAAO,CAAC,MAAM,EAAE,MAAM,CAAC,KAAK,CAAC,CAAC,CAAA;SAC9C;aAAM;YACH,KAAK,GAAG,MAAM,CAAC,YAAY,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC,CAAA;SAC/C;KACJ;IACD,IAAI,KAAK,GAAG,GAAG,GAAG,GAAG,EAAE;QACnB,KAAK,GAAG,GAAG,GAAG,GAAG,CAAC;KACrB;IAED,IAAI,GAAG,GAAG,KAAK,GAAG,EAAE,CAAC;IACrB,GAAG,CAAC,KAAK,CAAC,QAAQ,GAAM,GAAG,OAAI,CAAC;;IAGhC,IAAI,UAAU,GAAG,UAAU,CAAC,gBAAgB,CAAC,GAAG,CAAC,CAAC,QAAQ,CAAC,CAAC;IAC5D,IAAI,UAAU,IAAI,GAAG,EAAE;QACnB,GAAG,CAAC,KAAK,CAAC,QAAQ,IAAM,GAAG,GAAG,GAAG,GAAG,kBAAc,CAAC;KACtD;IAED,QAAQ,CAAC,GAAG,GAAG,GAAG,CAAC;AACvB,CAAC;AAED;AACA,SAAS,gBAAgB;IACrB,MAAM,CAAC,gBAAgB,CAAC,QAAQ,EAAE;QAC9B,YAAY,CAAC,GAAG,CAAC,CAAC;QAClB,GAAG,GAAG,UAAU,CAAC,UAAU,EAAE,GAAG,CAAC,CAAC;KACrC,EAAE,KAAK,CAAC,CAAC;IACV,MAAM,CAAC,gBAAgB,CAAC,UAAU,EAAE,UAAU,CAAC;QAC3C,IAAI,CAAC,CAAC,SAAS,EAAE;YACb,YAAY,CAAC,GAAG,CAAC,CAAC;YAClB,GAAG,GAAG,UAAU,CAAC,UAAU,EAAE,GAAG,CAAC,CAAC;SACrC;KACJ,EAAE,KAAK,CAAC,CAAC;IAEV,IAAI,GAAG,CAAC,UAAU,KAAK,UAAU,EAAE;QAC/B,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,IAAM,EAAE,GAAG,WAAO,CAAC;KAC7C;SAAM;QACH,GAAG,CAAC,gBAAgB,CAAC,kBAAkB,EAAE;YACrC,GAAG,CAAC,IAAI,CAAC,KAAK,CAAC,QAAQ,IAAM,EAAE,GAAG,WAAO,CAAC;SAC7C,EAAE,KAAK,CAAC,CAAC;KACb;AACL,CAAC;AAID;;;;;SAKwB,IAAI,CAAC,CAAS,EAAE,GAAmB;gCAAL;IAMlD,WAAW,CACP,CAAC,IAAI,MAAM,CAAC,QAAQ,CAAC,IAAI,EACvB,GAAG,CACR,CAAC;IAEF,WAAW,EAAE,CAAC;IAEd,gBAAgB,EAAE,CAAC;IAEnB,UAAU,EAAE,CAAC;;IAGb,QAAQ,CAAC,GAAG,GAAG,GAAG,CAAC;IACnB,QAAQ,CAAC,UAAU,GAAG,UAAU,CAAC;IACjC,QAAQ,CAAC,MAAM,GAAG,UAAU,CAAC;QACzB,IAAI,GAAG,GAAQ,UAAU,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC;QACxC,IAAI,OAAO,CAAC,KAAK,QAAQ,IAAI,CAAC,CAAC,KAAK,CAAC,MAAM,CAAC,EAAE;YAC1C,GAAG,IAAI,IAAI,CAAC;SACf;QACD,OAAO,GAAG,CAAC;KACd,CAAA;IACD,QAAQ,CAAC,MAAM,GAAG,UAAU,CAAC;QACzB,IAAI,GAAG,GAAQ,UAAU,CAAC,CAAC,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC;QACxC,IAAI,OAAO,CAAC,KAAK,QAAQ,IAAI,CAAC,CAAC,KAAK,CAAC,KAAK,CAAC,EAAE;YACzC,GAAG,IAAI,KAAK,CAAC;SAChB;QACD,OAAO,GAAG,CAAC;KACd,CAAA;AACL;;;;;"}